{% extends "base.html" %}

{% block title %}× ×™×”×•×œ ×ª×œ××™×“×™× - ××¢×¨×›×ª × ×™×”×•×œ ×™×©×™×‘×”{% endblock %}

{% block content %}
<div class="students-container">
    <!-- Header -->
    <div class="page-header">
        <h1>× ×™×”×•×œ ×ª×œ××™×“×™×</h1>
    </div>

    <!-- Action Buttons -->
    <div class="action-bar">
        <button class="btn btn-success" onclick="openAddStudentDialog()">
            <span>â•</span> ×”×•×¡×£ ×ª×œ××™×“ ×—×“×©
        </button>
        <button class="btn btn-info" onclick="openImportModal()">
            <span>ğŸ“¥</span> ×™×™×‘×•× ×-Excel
        </button>
        <a href="/api/students/template" class="btn btn-secondary">
            <span>ğŸ“„</span> ×”×•×¨×“ ×ª×‘× ×™×ª
        </a>
        <button class="btn btn-secondary" onclick="refreshStudents()">
            <span>ğŸ”„</span> ×¨×¢× ×Ÿ
        </button>
    </div>
    
    <!-- Import Modal -->
    <div id="importModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“¥ ×™×™×‘×•× ×ª×œ××™×“×™× ×-Excel</h2>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="import-instructions">
                    <h3>×”×•×¨××•×ª ×™×™×‘×•×:</h3>
                    <ol>
                        <li>×”×•×¨×“ ××ª <a href="/api/students/template">×ª×‘× ×™×ª ×”×™×™×‘×•×</a></li>
                        <li>××œ× ××ª ×¤×¨×˜×™ ×”×ª×œ××™×“×™× ×‘×§×•×‘×¥</li>
                        <li>×”×¢×œ×” ××ª ×”×§×•×‘×¥ ×›××Ÿ</li>
                    </ol>
                    <p><strong>×¢××•×“×•×ª ×—×•×‘×”:</strong> ×©× ×¤×¨×˜×™, ×©× ××©×¤×—×”</p>
                </div>
                
                <div class="file-upload-area" id="dropZone">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileSelect(event)" style="display: none;">
                    <div class="upload-icon">ğŸ“</div>
                    <p>×’×¨×•×¨ ×§×•×‘×¥ Excel ×œ×›××Ÿ</p>
                    <p>××•</p>
                    <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                        ×‘×—×¨ ×§×•×‘×¥
                    </button>
                    <p id="selectedFileName" class="file-name"></p>
                </div>
                
                <div id="importProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">××™×™×‘×...</p>
                </div>
                
                <div id="importResult" style="display: none;" class="import-result"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">×¡×’×•×¨</button>
                <button class="btn btn-primary" id="importBtn" onclick="startImport()" disabled>
                    ×™×™×‘× ×ª×œ××™×“×™×
                </button>
            </div>
        </div>
    </div>

    <!-- Students Table with Filters -->
    <div class="content-card">
        <!-- Advanced Multi-Column Filter Bar -->
        <div class="advanced-filter-bar">
            <!-- Search Box -->
            <div class="filter-section search-section">
                <input type="text" id="searchInput" placeholder="ğŸ” ×—×™×¤×•×© ×—×•×¤×©×™ (×©×, ×ª.×–.)..."
                       onkeyup="applyFilters()">
            </div>

            <!-- Grade Filter - 3 Toggle Buttons -->
            <div class="filter-section grade-section">
                <label class="filter-label">×©×™×¢×•×¨:</label>
                <div class="grade-toggle-buttons">
                    <button class="grade-btn active" data-grade="×'" onclick="toggleGradeFilter(&quot;×'&quot;)">×'</button>
                    <button class="grade-btn active" data-grade="×‘'" onclick="toggleGradeFilter(&quot;×‘'&quot;)">×‘'</button>
                    <button class="grade-btn active" data-grade="×’'" onclick="toggleGradeFilter(&quot;×’'&quot;)">×’'</button>
                </div>
            </div>

            <!-- City Filter - Dropdown with Checkboxes -->
            <div class="filter-section city-section">
                <label class="filter-label">×¢×™×¨:</label>
                <div class="dropdown-filter">
                    <button class="dropdown-btn" onclick="toggleCityDropdown()">
                        <span id="cityFilterText">×›×œ ×”×¢×¨×™×</span> â–¼
                    </button>
                    <div class="dropdown-content" id="cityDropdown" style="display: none;">
                        <label class="checkbox-label">
                            <input type="checkbox" value="all" id="allCitiesCheckbox" checked> ×”×›×œ
                        </label>
                        <div id="cityCheckboxes"></div>
                    </div>
                </div>
            </div>

            <!-- Status Filter - Toggle Buttons -->
            <div class="filter-section status-section">
                <label class="filter-label">×¡×˜×˜×•×¡:</label>
                <div class="status-toggle-buttons">
                    <button class="status-btn active" data-status="×¤×¢×™×œ" onclick="toggleStatusFilter('×¤×¢×™×œ')">×¤×¢×™×œ</button>
                    <button class="status-btn active" data-status="×œ× ×¤×¢×™×œ" onclick="toggleStatusFilter('×œ× ×¤×¢×™×œ')">×œ× ×¤×¢×™×œ</button>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <button class="btn-clear-filters" onclick="clearAllFilters()">ğŸ”„ × ×§×” ×”×›×œ</button>
        </div>

        <h2 class="card-title">×¨×©×™××ª ×ª×œ××™×“×™×</h2>
        <div class="table-wrapper">
            <table class="students-table">
                <thead>
                    <tr>
                        <th onclick="handleSort('first_name')" data-column="first_name">×©× ×¤×¨×˜×™ <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('last_name')" data-column="last_name">×©× ××©×¤×—×” <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('grade')" data-column="grade">×©×™×¢×•×¨ <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('id_number')" data-column="id_number">×ª.×–. <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('birth_date_hebrew')" data-column="birth_date_hebrew">×ª××¨×™×š ×œ×™×“×” <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('address')" data-column="address">×›×ª×•×‘×ª <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('city')" data-column="city">×¢×™×¨ <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('father_name')" data-column="father_name">×©× ×”××‘ <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('father_id_number')" data-column="father_id_number">×ª.×–. ××‘ <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('mother_name')" data-column="mother_name">×©× ×”×× <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('mother_id_number')" data-column="mother_id_number">×ª.×–. ×× <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('home_phone')" data-column="home_phone">×˜×œ×¤×•×Ÿ ×‘×™×ª <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('mobile_phone')" data-column="mobile_phone">×¤×œ××¤×•×Ÿ <span class="sort-indicator"></span></th>
                        <th onclick="handleSort('status')" data-column="status">×¡×˜×˜×•×¡ <span class="sort-indicator"></span></th>
                        <th style="min-width: 120px;">×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="studentsList">
                    <tr class="loading-row">
                        <td colspan="15">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="emptyMessage" class="empty-message" style="display: none;">
            ×œ× × ××¦××• ×ª×œ××™×“×™× ×‘×”×ª×× ×œ×¤×™×œ×˜×¨×™× ×©×œ×š
        </div>
    </div>
</div>

<!-- Add/Edit Student Modal -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>×”×•×¡×£ ×ª×œ××™×“ ×—×“×©</h2>
            <span class="close" onclick="closeAddStudentDialog()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="studentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentFirstName">×©× ×¤×¨×˜×™:<span class="required">*</span></label>
                        <input type="text" id="studentFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="studentLastName">×©× ××©×¤×—×”:<span class="required">*</span></label>
                        <input type="text" id="studentLastName" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="studentIdNumber">×ª.×–.:</label>
                        <input type="text" id="studentIdNumber" maxlength="9">
                    </div>
                    <div class="form-group">
                        <label for="studentBirthDate">×ª××¨×™×š ×œ×™×“×”:</label>
                        <input type="text" id="studentBirthDate" placeholder="×™×•×/×—×•×“×©/×©× ×”">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="studentAddress">×›×ª×•×‘×ª:</label>
                        <input type="text" id="studentAddress">
                    </div>
                    <div class="form-group">
                        <label for="studentCity">×¢×™×¨:</label>
                        <input type="text" id="studentCity">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fatherName">×©× ×”××‘:</label>
                        <input type="text" id="fatherName">
                    </div>
                    <div class="form-group">
                        <label for="fatherIdNumber">×ª.×–. ××‘:</label>
                        <input type="text" id="fatherIdNumber" maxlength="9">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="motherName">×©× ×”××:</label>
                        <input type="text" id="motherName">
                    </div>
                    <div class="form-group">
                        <label for="motherIdNumber">×ª.×–. ××:</label>
                        <input type="text" id="motherIdNumber" maxlength="9">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="homePhone">×˜×œ×¤×•×Ÿ ×‘×™×ª:</label>
                        <input type="tel" id="homePhone">
                    </div>
                    <div class="form-group">
                        <label for="mobilePhone">×¤×œ××¤×•×Ÿ:</label>
                        <input type="tel" id="mobilePhone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="studentGrade">×©×™×¢×•×¨:<span class="required">*</span></label>
                        <select id="studentGrade" required>
                            <option value="">×‘×—×¨ ×©×™×¢×•×¨...</option>
                            <option value="×'">×'</option>
                            <option value="×‘'">×‘'</option>
                            <option value="×’'">×’'</option>
                            <option value="×“'">×“'</option>
                            <option value="×”'">×”'</option>
                            <option value="×•'">×•'</option>
                            <option value="×–'">×–'</option>
                            <option value="×—'">×—'</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddStudentDialog()">×‘×™×˜×•×œ</button>
            <button class="btn btn-success" onclick="saveStudent()">×©××•×¨</button>
        </div>
    </div>
</div>

<script>
    let allStudents = [];
    let sortRules = [];  // ××¢×¨×š ×›×œ×œ×™ ×”××™×•×Ÿ

    // ××¦×‘ ×”×¡×™× ×•× ×™×
    let activeFilters = {
        search: '',
        grades: ['×\'', '×‘\'', '×’\''],  // ×›×œ ×”×©×™×¢×•×¨×™× ×¤×¢×™×œ×™× ×‘×‘×¨×™×¨×ª ××—×“×œ
        cities: [],  // ×¨×™×§ = ×”×›×œ ×¤×¢×™×œ
        statuses: ['×¤×¢×™×œ', '×œ× ×¤×¢×™×œ']  // ×©× ×™ ×”×¡×˜×˜×•×¡×™× ×¤×¢×™×œ×™× ×‘×‘×¨×™×¨×ª ××—×“×œ
    };

    function loadStudents() {
        fetch('/api/students')
            .then(response => response.json())
            .then(data => {
                allStudents = data;
                buildCityFilter();  // ×‘× ×™×™×ª ×¨×©×™××ª ×¢×¨×™× ×“×™× ××™×ª
                applySortAndDisplay();
            })
            .catch(error => console.error('Error:', error));
    }

    // ×‘× ×™×™×ª ×¨×©×™××ª ×¢×¨×™× ×“×™× ××™×ª
    function buildCityFilter() {
        const cities = [...new Set(allStudents.map(s => s.city).filter(c => c))].sort();
        const cityCheckboxes = document.getElementById('cityCheckboxes');

        cityCheckboxes.innerHTML = cities.map(city => `
            <label class="checkbox-label">
                <input type="checkbox" value="${city}" checked data-city="${city}"> ${city}
            </label>
        `).join('');
        
        // Add event listeners to checkboxes
        cityCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleCityFilter(this.dataset.city);
            });
        });

        activeFilters.cities = cities;  // ×›×œ ×”×¢×¨×™× ×¤×¢×™×œ×•×ª ×‘×‘×¨×™×¨×ª ××—×“×œ
    }

    // ×¤×•× ×§×¦×™×” ×œ×˜×™×¤×•×œ ×‘×œ×—×™×¦×” ×¢×œ ×›×•×ª×¨×ª ×˜×‘×œ×”
    function handleSort(column) {
        const existingIndex = sortRules.findIndex(rule => rule.column === column);

        if (existingIndex !== -1) {
            // ×”×¢××•×“×” ×›×‘×¨ ×§×™×™××ª - ×”×¤×•×š ×›×™×•×•×Ÿ ××• ××—×§
            if (sortRules[existingIndex].direction === 'asc') {
                sortRules[existingIndex].direction = 'desc';
            } else {
                // ×œ×—×™×¦×” ×©×œ×™×©×™×ª - ××—×§ ××ª ×”×›×œ×œ
                sortRules.splice(existingIndex, 1);
            }
        } else {
            // ×”×¢××•×“×” ×—×“×©×” - ×”×•×¡×£ ×‘×¡×•×£
            sortRules.push({
                column: column,
                direction: 'asc',
                order: sortRules.length + 1
            });
        }

        // ×¢×“×›×Ÿ ××¡×¤×¨×™ ×¡×“×¨
        sortRules.forEach((rule, index) => rule.order = index + 1);

        applySortAndDisplay();
    }

    // ×¤×•× ×§×¦×™×” ×œ×‘×™×¦×•×¢ ×”×¡×™× ×•×Ÿ ×•×”××™×•×Ÿ
    function applySortAndDisplay() {
        // ×¢×“×›×•×Ÿ ××¦×‘ ×—×™×¤×•×©
        activeFilters.search = document.getElementById('searchInput')?.value.toLowerCase() || '';

        // ×¡×™× ×•×Ÿ ××ª×§×“× ×¨×‘-×¢××•×“×ª×™
        let filtered = allStudents.filter(student => {
            // ×—×™×¤×•×© ×—×•×¤×©×™
            const matchSearch = !activeFilters.search ||
                               student.first_name?.toLowerCase().includes(activeFilters.search) ||
                               student.last_name?.toLowerCase().includes(activeFilters.search) ||
                               student.id_number?.includes(activeFilters.search);

            // ×¡×™× ×•×Ÿ ×©×™×¢×•×¨ (××¡×¤×¨ ××¤×©×¨×•×™×•×ª)
            const matchGrade = activeFilters.grades.includes(student.grade);

            // ×¡×™× ×•×Ÿ ×¢×™×¨ (×¨×™×§ = ×”×›×œ)
            const matchCity = activeFilters.cities.length === 0 ||
                             activeFilters.cities.includes(student.city) ||
                             (!student.city && activeFilters.cities.includes(''));

            // ×¡×™× ×•×Ÿ ×¡×˜×˜×•×¡
            const matchStatus = activeFilters.statuses.includes(student.status);

            return matchSearch && matchGrade && matchCity && matchStatus;
        });

        // ×× ××™×Ÿ ×›×œ×œ×™ ××™×•×Ÿ, ×”×¦×’ ×›××• ×©×–×”
        if (sortRules.length === 0) {
            displayStudents(filtered);
            updateSortIndicators();
            return;
        }

        // ××™×•×Ÿ ×¨×‘-×¢××•×“×ª×™
        const sorted = [...filtered].sort((a, b) => {
            for (const rule of sortRules) {
                const aValue = a[rule.column] || '';
                const bValue = b[rule.column] || '';

                let comparison = 0;
                if (aValue < bValue) comparison = -1;
                if (aValue > bValue) comparison = 1;

                // ×× ×™×© ×”×‘×“×œ, ×”×—×–×¨ ××ª ×”×ª×•×¦××”
                if (comparison !== 0) {
                    return rule.direction === 'asc' ? comparison : -comparison;
                }
            }
            return 0;
        });

        displayStudents(sorted);
        updateSortIndicators();
    }

    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×”××™× ×“×™×§×˜×•×¨×™× ×”×•×™×–×•××œ×™×™×
    function updateSortIndicators() {
        // × ×§×” ××ª ×›×œ ×”××™× ×“×™×§×˜×•×¨×™×
        document.querySelectorAll('.sort-indicator').forEach(span => {
            span.innerHTML = '';
            span.parentElement.classList.remove('sorted-asc', 'sorted-desc');
        });

        // ×”×•×¡×£ ××™× ×“×™×§×˜×•×¨×™× ×œ×¢××•×“×•×ª ××¡×•× × ×•×ª
        sortRules.forEach(rule => {
            const th = document.querySelector(`th[data-column="${rule.column}"]`);
            if (th) {
                const indicator = th.querySelector('.sort-indicator');

                // ×—×¥ + ××¡×¤×¨ ×¡×“×¨ (×× ×™×© ×™×•×ª×¨ ××›×œ×œ ××—×“)
                const arrow = rule.direction === 'asc' ? 'â†‘' : 'â†“';
                const orderNum = sortRules.length > 1 ? `<sub>${rule.order}</sub>` : '';
                indicator.innerHTML = `${arrow}${orderNum}`;

                // ×”×•×¡×£ class ×œ×¢×™×¦×•×‘
                th.classList.add(rule.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        });
    }

    function displayStudents(students) {
        const tbody = document.getElementById('studentsList');
        const emptyMessage = document.getElementById('emptyMessage');

        if (students.length === 0) {
            tbody.innerHTML = '';
            emptyMessage.style.display = 'block';
            return;
        }

        emptyMessage.style.display = 'none';
        tbody.innerHTML = students.map(student => `
            <tr>
                <td>${student.first_name || '-'}</td>
                <td>${student.last_name || '-'}</td>
                <td>${student.grade}</td>
                <td>${student.id_number || '-'}</td>
                <td>${student.birth_date_hebrew || '-'}</td>
                <td>${student.address || '-'}</td>
                <td>${student.city || '-'}</td>
                <td>${student.father_name || '-'}</td>
                <td>${student.father_id_number || '-'}</td>
                <td>${student.mother_name || '-'}</td>
                <td>${student.mother_id_number || '-'}</td>
                <td>${student.home_phone || '-'}</td>
                <td>${student.mobile_phone || '-'}</td>
                <td><span class="status-badge ${student.status === '×¤×¢×™×œ' ? 'active' : 'inactive'}">${student.status}</span></td>
                <td class="action-buttons">
                    <button class="btn-icon report" onclick="openStudentReport(${student.id})" title="×“×•×— ×¤×¨×˜×™">ğŸ“„</button>
                    <button class="btn-icon edit" onclick="editStudent(${student.id})" title="×¢×¨×•×š">âœï¸</button>
                    <button class="btn-icon delete" onclick="deleteStudent(${student.id})" title="××—×§">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `).join('');
    }

    // ===== ×¤×•× ×§×¦×™×•×ª ×¡×™× ×•×Ÿ ×—×“×©×•×ª =====

    // ×¡×™× ×•×Ÿ ×©×™×¢×•×¨ - Toggle
    function toggleGradeFilter(grade) {
        const gradeWithQuote = grade;
        const btn = document.querySelector(`.grade-btn[data-grade="${gradeWithQuote}"]`);

        if (activeFilters.grades.includes(gradeWithQuote)) {
            // ×”×¡×¨ ××ª ×”×©×™×¢×•×¨
            activeFilters.grades = activeFilters.grades.filter(g => g !== gradeWithQuote);
            btn.classList.remove('active');
        } else {
            // ×”×•×¡×£ ××ª ×”×©×™×¢×•×¨
            activeFilters.grades.push(gradeWithQuote);
            btn.classList.add('active');
        }

        applyFilters();
    }

    // ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ dropdown ×¢×¨×™×
    function toggleCityDropdown() {
        const dropdown = document.getElementById('cityDropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    // Toggle ×›×œ ×”×¢×¨×™×
    function toggleAllCities(event) {
        const allCheckbox = event.target;
        const cityCheckboxes = document.querySelectorAll('#cityCheckboxes input[type="checkbox"]');

        if (allCheckbox.checked) {
            // ×¡××Ÿ ×”×›×œ
            cityCheckboxes.forEach(cb => cb.checked = true);
            const cities = [...new Set(allStudents.map(s => s.city).filter(c => c))];
            activeFilters.cities = cities;
        } else {
            // ×‘×˜×œ ×”×›×œ
            cityCheckboxes.forEach(cb => cb.checked = false);
            activeFilters.cities = [];
        }

        updateCityFilterText();
        applyFilters();
    }

    // Toggle ×¢×™×¨ ×¡×¤×¦×™×¤×™×ª
    function toggleCityFilter(city) {
        const allCheckbox = document.querySelector('#cityDropdown input[value="all"]');

        if (activeFilters.cities.includes(city)) {
            activeFilters.cities = activeFilters.cities.filter(c => c !== city);
        } else {
            activeFilters.cities.push(city);
        }

        // ×¢×“×›×•×Ÿ checkbox "×”×›×œ"
        const allCities = [...new Set(allStudents.map(s => s.city).filter(c => c))];
        allCheckbox.checked = activeFilters.cities.length === allCities.length;

        updateCityFilterText();
        applyFilters();
    }

    // ×¢×“×›×•×Ÿ ×˜×§×¡×˜ ×›×¤×ª×•×¨ ×”×¢×¨×™×
    function updateCityFilterText() {
        const textSpan = document.getElementById('cityFilterText');
        const allCities = [...new Set(allStudents.map(s => s.city).filter(c => c))];

        if (activeFilters.cities.length === 0 || activeFilters.cities.length === allCities.length) {
            textSpan.textContent = '×›×œ ×”×¢×¨×™×';
        } else if (activeFilters.cities.length === 1) {
            textSpan.textContent = activeFilters.cities[0];
        } else {
            textSpan.textContent = `${activeFilters.cities.length} ×¢×¨×™×`;
        }
    }

    // ×¡×™× ×•×Ÿ ×¡×˜×˜×•×¡ - Toggle
    function toggleStatusFilter(status) {
        const btn = document.querySelector(`.status-btn[data-status="${status}"]`);

        if (activeFilters.statuses.includes(status)) {
            activeFilters.statuses = activeFilters.statuses.filter(s => s !== status);
            btn.classList.remove('active');
        } else {
            activeFilters.statuses.push(status);
            btn.classList.add('active');
        }

        applyFilters();
    }

    // × ×™×§×•×™ ×›×œ ×”×¡×™× ×•× ×™×
    function clearAllFilters() {
        // ××™×¤×•×¡ ××¦×‘ ×¡×™× ×•× ×™×
        activeFilters = {
            search: '',
            grades: ['×\'', '×‘\'', '×’\''],
            cities: [],
            statuses: ['×¤×¢×™×œ', '×œ× ×¤×¢×™×œ']
        };

        // ××™×¤×•×¡ UI
        document.getElementById('searchInput').value = '';

        // ×›×¤×ª×•×¨×™ ×©×™×¢×•×¨
        document.querySelectorAll('.grade-btn').forEach(btn => btn.classList.add('active'));

        // checkboxes ×¢×¨×™×
        document.querySelectorAll('#cityDropdown input[type="checkbox"]').forEach(cb => cb.checked = true);
        const cities = [...new Set(allStudents.map(s => s.city).filter(c => c))];
        activeFilters.cities = cities;
        updateCityFilterText();

        // ×›×¤×ª×•×¨×™ ×¡×˜×˜×•×¡
        document.querySelectorAll('.status-btn').forEach(btn => btn.classList.add('active'));

        // ××™×¤×•×¡ ××™×•×Ÿ
        sortRules = [];

        applyFilters();
    }

    // ×¤×•× ×§×¦×™×” ××¨×›×–×™×ª ×œ×”×¤×¢×œ×ª ×¡×™× ×•×Ÿ
    function applyFilters() {
        applySortAndDisplay();
    }

    // ×¡×’×™×¨×ª dropdown ×›×©×œ×•×—×¦×™× ×‘×—×•×¥
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('cityDropdown');
        const btn = event.target.closest('.dropdown-btn');

        if (!btn && !event.target.closest('.dropdown-content')) {
            dropdown.style.display = 'none';
        }
    });

    function openAddStudentDialog() {
        document.getElementById('studentForm').reset();
        document.getElementById('studentModal').style.display = 'block';
    }

    function closeAddStudentDialog() {
        document.getElementById('studentModal').style.display = 'none';
        document.getElementById('studentForm').reset();
    }

    async function saveStudent() {
        // ××™×¡×•×£ × ×ª×•× ×™× ××”×˜×•×¤×¡
        const studentData = {
            first_name: document.getElementById('studentFirstName').value.trim(),
            last_name: document.getElementById('studentLastName').value.trim(),
            id_number: document.getElementById('studentIdNumber').value.trim(),
            birth_date_hebrew: document.getElementById('studentBirthDate').value.trim(),
            address: document.getElementById('studentAddress').value.trim(),
            city: document.getElementById('studentCity').value.trim(),
            father_name: document.getElementById('fatherName').value.trim(),
            father_id_number: document.getElementById('fatherIdNumber').value.trim(),
            mother_name: document.getElementById('motherName').value.trim(),
            mother_id_number: document.getElementById('motherIdNumber').value.trim(),
            home_phone: document.getElementById('homePhone').value.trim(),
            mobile_phone: document.getElementById('mobilePhone').value.trim(),
            current_grade: document.getElementById('studentGrade').value
        };

        // ×‘×“×™×§×ª ×©×“×•×ª ×—×•×‘×”
        if (!studentData.first_name || !studentData.last_name || !studentData.current_grade) {
            alert('×™×© ×œ××œ× ×©× ×¤×¨×˜×™, ×©× ××©×¤×—×” ×•×©×™×¢×•×¨');
            return;
        }

        try {
            const response = await fetch('/api/students', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(studentData)
            });

            const result = await response.json();

            if (result.success) {
                alert('×”×ª×œ××™×“ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                closeAddStudentDialog();
                loadStudents(); // ×¨×¢× ×•×Ÿ ×”×¨×©×™××”
            } else {
                alert('×©×’×™××”: ' + result.error);
            }
        } catch (error) {
            alert('×©×’×™××” ×‘×©××™×¨×ª ×”×ª×œ××™×“: ' + error.message);
        }
    }

    function editStudent(id) {
        alert(`×¢×¨×™×›×” ×©×œ ×ª×œ××™×“ ${id} - ×‘×¢×“×›×•×Ÿ`);
    }

    function deleteStudent(id) {
        if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª×œ××™×“ ×–×”?')) {
            alert(`××—×™×§×” ×©×œ ×ª×œ××™×“ ${id} - ×‘×¢×“×›×•×Ÿ`);
        }
    }

    function refreshStudents() {
        loadStudents();
    }

    function openStudentReport(studentId) {
        window.location.href = `/student-report?student_id=${studentId}`;
    }

    // ==================== IMPORT FUNCTIONALITY ====================
    
    let selectedFile = null;
    
    function openImportModal() {
        document.getElementById('importModal').style.display = 'block';
        document.getElementById('importResult').style.display = 'none';
        document.getElementById('importProgress').style.display = 'none';
        document.getElementById('selectedFileName').textContent = '';
        document.getElementById('excelFile').value = '';
        document.getElementById('importBtn').disabled = true;
        selectedFile = null;
    }
    
    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }
    
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            selectedFile = file;
            document.getElementById('selectedFileName').textContent = `ğŸ“„ ${file.name}`;
            document.getElementById('importBtn').disabled = false;
        }
    }
    
    // Drag and drop
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                selectedFile = file;
                document.getElementById('selectedFileName').textContent = `ğŸ“„ ${file.name}`;
                document.getElementById('importBtn').disabled = false;
            } else {
                alert('×™×© ×œ×”×¢×œ×•×ª ×§×•×‘×¥ Excel ×‘×œ×‘×“ (.xlsx ××• .xls)');
            }
        });
    }
    
    function startImport() {
        if (!selectedFile) {
            alert('×‘×—×¨ ×§×•×‘×¥ ×œ×™×™×‘×•×');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        document.getElementById('importProgress').style.display = 'block';
        document.getElementById('importBtn').disabled = true;
        document.getElementById('progressText').textContent = '××™×™×‘× ×ª×œ××™×“×™×...';
        
        fetch('/api/students/import', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(result => {
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResult').style.display = 'block';
            
            if (result.success) {
                let html = `<div class="success-msg">âœ… ${result.message}</div>`;
                if (result.errors && result.errors.length > 0) {
                    html += `<div class="warning-msg">âš ï¸ ${result.total_errors} ×©×’×™××•×ª:</div>`;
                    html += '<ul class="error-list">';
                    result.errors.forEach(err => {
                        html += `<li>${err}</li>`;
                    });
                    html += '</ul>';
                }
                document.getElementById('importResult').innerHTML = html;
                
                // Refresh the students list
                loadStudents();
            } else {
                document.getElementById('importResult').innerHTML = 
                    `<div class="error-msg">âŒ ×©×’×™××”: ${result.error}</div>`;
            }
        })
        .catch(err => {
            console.error('Import error:', err);
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResult').style.display = 'block';
            document.getElementById('importResult').innerHTML = 
                '<div class="error-msg">âŒ ×©×’×™××” ×‘×™×™×‘×•×</div>';
        });
    }

    // Load on page load
    // Add event listener for "all cities" checkbox
    document.addEventListener('DOMContentLoaded', function() {
        const allCitiesCheckbox = document.getElementById('allCitiesCheckbox');
        if (allCitiesCheckbox) {
            allCitiesCheckbox.addEventListener('change', toggleAllCities);
        }
    });

    window.addEventListener('load', loadStudents);
</script>

<style>
/* Import Modal Styles */
.import-instructions {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.import-instructions h3 {
    margin-bottom: 10px;
    font-size: 16px;
}

.import-instructions ol {
    margin-right: 20px;
    margin-bottom: 10px;
}

.import-instructions li {
    margin-bottom: 5px;
}

.file-upload-area {
    border: 2px dashed #ccc;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    margin-bottom: 20px;
    transition: all 0.3s;
}

.file-upload-area.drag-over {
    border-color: #3b82f6;
    background: #eff6ff;
}

.upload-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

.file-name {
    margin-top: 15px;
    color: #22c55e;
    font-weight: 600;
}

.progress-bar {
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-fill {
    height: 100%;
    background: #3b82f6;
    width: 0%;
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}

.import-result {
    padding: 15px;
    border-radius: 8px;
}

.success-msg {
    color: #22c55e;
    font-weight: 600;
    margin-bottom: 10px;
}

.warning-msg {
    color: #f59e0b;
    margin-bottom: 5px;
}

.error-msg {
    color: #ef4444;
    font-weight: 600;
}

.error-list {
    margin-right: 20px;
    font-size: 12px;
    color: #666;
}

.btn-info {
    background: #3b82f6;
    color: white;
}
</style>
{% endblock %}
