{% extends "base.html" %}

{% block title %}× ×•×›×—×•×ª ×©×—×¨×™×ª - ××¢×¨×›×ª × ×™×”×•×œ ×™×©×™×‘×”{% endblock %}

{% block content %}
<div class="attendance-container">
    <!-- Header -->
    <div class="page-header">
        <h1>× ×•×›×—×•×ª ×©×—×¨×™×ª</h1>
    </div>

    <!-- Week Navigation -->
    <div class="week-navigation">
        <button class="btn btn-secondary" onclick="previousWeek()">â† ×©×‘×•×¢ ×§×•×“×</button>
        <div class="week-display">
            <div id="weekRange" class="week-range">×ª××¨×™×š</div>
        </div>
        <button class="btn btn-secondary" onclick="goToThisWeek()">×”×©×‘×•×¢</button>
        <button class="btn btn-secondary" onclick="nextWeek()">×©×‘×•×¢ ×”×‘× â†’</button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-row">
        <!-- Present -->
        <div class="stat-card card-success">
            <div class="card-border"></div>
            <div class="card-content">
                <div class="card-value" id="presentCount">0</div>
                <div class="card-label">× ×•×›×—×™×</div>
            </div>
        </div>

        <!-- Absent -->
        <div class="stat-card card-danger">
            <div class="card-border"></div>
            <div class="card-content">
                <div class="card-value" id="absentCount">0</div>
                <div class="card-label">×—×¡×¨×™×</div>
            </div>
        </div>

        <!-- Unmarked -->
        <div class="stat-card card-warning">
            <div class="card-border"></div>
            <div class="card-content">
                <div class="card-value" id="unmarkedCount">0</div>
                <div class="card-label">×œ× ×¡×•×× ×•</div>
            </div>
        </div>

        <!-- Percentage -->
        <div class="stat-card card-info">
            <div class="card-border"></div>
            <div class="card-content">
                <div class="card-value" id="percentCount">0%</div>
                <div class="card-label">××—×•×– × ×•×›×—×•×ª</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="action-bar">
        <button class="btn btn-primary" onclick="startRapidFilling()">
            <span>âš¡</span> ××™×œ×•×™ ×¨×¥
        </button>
        <button class="btn btn-success" onclick="markAllPresent()">
            <span>âœ“</span> ×¡××Ÿ ××ª ×›×•×œ× × ×•×›×—×™×
        </button>
        <button class="btn btn-danger" onclick="markAllAbsent()">
            <span>âœ—</span> ×¡××Ÿ ××ª ×›×•×œ× ×—×¡×¨×™×
        </button>
    </div>

    <!-- Prayer Selector Tabs -->
    <div class="prayer-selector">
        <button class="prayer-tab active" onclick="selectPrayer('×©×—×¨×™×ª')" data-prayer="×©×—×¨×™×ª">
            <span class="prayer-icon">ğŸŒ…</span>
            <span class="prayer-label">×©×—×¨×™×ª</span>
        </button>
        <button class="prayer-tab" onclick="selectPrayer('×× ×—×”')" data-prayer="×× ×—×”">
            <span class="prayer-icon">â˜€ï¸</span>
            <span class="prayer-label">×× ×—×”</span>
        </button>
        <button class="prayer-tab" onclick="selectPrayer('××¢×¨×™×‘')" data-prayer="××¢×¨×™×‘">
            <span class="prayer-icon">ğŸŒ™</span>
            <span class="prayer-label">××¢×¨×™×‘</span>
        </button>
    </div>

    <!-- Lesson Selector Tabs -->
    <div class="class-selector">
        <button class="class-tab active" onclick="selectClass(&quot;×'&quot;)">
            <span class="class-letter">×</span>
            <span class="class-label">×©×™×¢×•×¨ ×</span>
            <span class="class-count" id="count×">0</span>
        </button>
        <button class="class-tab" onclick="selectClass(&quot;×‘'&quot;)">
            <span class="class-letter">×‘</span>
            <span class="class-label">×©×™×¢×•×¨ ×‘</span>
            <span class="class-count" id="count×‘">0</span>
        </button>
        <button class="class-tab" onclick="selectClass(&quot;×’'&quot;)">
            <span class="class-letter">×’</span>
            <span class="class-label">×©×™×¢×•×¨ ×’</span>
            <span class="class-count" id="count×’">0</span>
        </button>
    </div>

    <!-- Weekly Attendance Table -->
    <div class="content-card">
        <h2 class="card-title" id="classTitle">× ×•×›×—×•×ª ×©×—×¨×™×ª - ×©×™×¢×•×¨ ×</h2>
        <div class="weekly-table-wrapper">
            <table class="weekly-attendance-table" id="attendanceTable">
                <thead>
                    <tr id="headerRow">
                        <th class="student-col">×©× ×”×ª×œ××™×“</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" class="loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Day Selection Modal for Rapid Filling -->
<div id="daySelectionModal" class="modal">
    <div class="modal-content day-selection-modal">
        <div class="modal-header">
            <h2>âš¡ ×‘×—×¨ ×™×•× ×œ××™×œ×•×™ ×¨×¥</h2>
            <span class="close" onclick="closeDaySelection()">&times;</span>
        </div>
        <div class="modal-body day-selection-body">
            <p class="day-selection-title">×‘×—×¨ ××ª ×”×™×•× ×©×‘×¨×¦×•× ×š ×œ××œ×:</p>
            <div id="daySelectionGrid" class="day-selection-grid">
                <!-- ×™×ª××œ× ×“×™× ××™×ª ×¢× ×™××™ ×”×©×‘×•×¢ -->
            </div>
        </div>
    </div>
</div>

<!-- Rapid Filling Modal -->
<div id="rapidFillingModal" class="modal">
    <div class="modal-content rapid-filling-modal-compact">
        <div class="modal-header">
            <h2>âš¡ ××™×œ×•×™ ×¨×¥</h2>
            <span class="close" onclick="closeRapidFilling()">&times;</span>
        </div>
        <div class="modal-body rapid-filling-body-compact">
            <!-- Progress indicator -->
            <div class="rapid-progress-indicator">
                <span id="rapidCurrentIndex">1</span> / <span id="rapidTotalCount">0</span>
                <div class="progress-bar">
                    <div id="rapidProgressBar" class="progress-fill"></div>
                </div>
            </div>

            <!-- Student info -->
            <div class="rapid-student-display">
                <div class="rapid-student-name" id="rapidStudentName">×˜×•×¢×Ÿ...</div>
                <div class="rapid-student-class" id="rapidStudentClass"></div>
            </div>

            <!-- Action buttons -->
            <div class="rapid-action-buttons">
                <button class="btn-rapid-action present" onclick="markRapidStudent(1)" title="××§×©: V">
                    <span class="icon">âœ“</span>
                    <span class="label">× ×•×›×—</span>
                    <span class="shortcut">(V)</span>
                </button>
                <button class="btn-rapid-action absent" onclick="markRapidStudent(0)" title="××§×©: X">
                    <span class="icon">âœ—</span>
                    <span class="label">×—×¡×¨</span>
                    <span class="shortcut">(X)</span>
                </button>
            </div>

            <!-- Skip button -->
            <div class="rapid-skip">
                <button class="btn-skip" onclick="skipRapidStudent()" title="××§×©: ×¨×•×•×—">
                    ×“×œ×’ (×¨×•×•×—)
                </button>
            </div>

            <!-- Stats footer -->
            <div class="rapid-stats-footer">
                <span class="stat-item present">× ×•×›×—×™×: <span id="rapidPresentCount">0</span></span>
                <span class="stat-item absent">×—×¡×¨×™×: <span id="rapidAbsentCount">0</span></span>
                <span class="stat-item pending">×××ª×™× ×™×: <span id="rapidUnmarkedCount">0</span></span>
            </div>
        </div>
    </div>
</div>

<script>
    // Helper functions must be defined before they're used
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day;
        return new Date(d.setDate(diff));
    }

    // State variables initialized after helper functions
    let weekStartDate = getStartOfWeek(new Date());
    let weeklyData = {};
    let selectedClass = "×'";
    let selectedPrayer = '×©×—×¨×™×ª';

    function getWeekDates(startDate) {
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            dates.push(date);
        }
        return dates;
    }

    function getHebrewDayName(dayIndex) {
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        return days[dayIndex];
    }

    function getClassStudents(students, classGrade) {
        return students.filter(student => student.grade === classGrade);
    }

    function selectPrayer(prayer) {
        selectedPrayer = prayer;
        document.querySelectorAll('.prayer-tab').forEach(tab => tab.classList.remove('active'));
        event.target.closest('.prayer-tab').classList.add('active');

        // Reload data for the new prayer
        loadWeeklyAttendance();
    }

    function selectClass(classGrade) {
        selectedClass = classGrade;
        document.querySelectorAll('.class-tab').forEach(tab => tab.classList.remove('active'));
        event.target.closest('.class-tab').classList.add('active');

        updateTitle();
        displayWeeklyTable();
    }

    function updateTitle() {
        const lessonLabel = selectedClass === "×'" ? '×©×™×¢×•×¨ ×' : selectedClass === "×‘'" ? '×©×™×¢×•×¨ ×‘' : '×©×™×¢×•×¨ ×’';
        document.getElementById('classTitle').textContent = `× ×•×›×—×•×ª ${selectedPrayer} - ${lessonLabel}`;
    }

    function loadWeeklyAttendance() {
        const weekDates = getWeekDates(weekStartDate);
        let loadedCount = 0;
        weeklyData = {};

        weekDates.forEach(date => {
            const dateStr = formatDate(date);
            fetch(`/api/attendance/${dateStr}/${selectedPrayer}`)
                .then(response => response.json())
                .then(data => {
                    weeklyData[dateStr] = data;
                    loadedCount++;
                    if (loadedCount === 7) {
                        updateWeekDisplay();
                        updateTitle();
                        displayWeeklyTable();
                    }
                })
                .catch(error => console.error('Error loading attendance:', error));
        });
    }

    function updateWeekDisplay() {
        const weekDates = getWeekDates(weekStartDate);
        const firstDate = weekDates[0];
        const lastDate = weekDates[6];

        const firstData = weeklyData[formatDate(firstDate)];
        const lastData = weeklyData[formatDate(lastDate)];

        let weekRangeText = '';
        if (firstData && lastData) {
            weekRangeText = `${firstData.hebrew_date} - ${lastData.hebrew_date}`;
        }
        document.getElementById('weekRange').textContent = weekRangeText || '×˜×•×¢×Ÿ ×ª××¨×™×›×™×...';
    }

    function displayWeeklyTable() {
        const weekDates = getWeekDates(weekStartDate);
        const headerRow = document.getElementById('headerRow');
        const tableBody = document.getElementById('tableBody');

        headerRow.innerHTML = '<th class="student-col">×©× ×”×ª×œ××™×“</th>';
        weekDates.forEach(date => {
            const dateStr = formatDate(date);
            const dayData = weeklyData[dateStr] || {};
            const dayName = getHebrewDayName(date.getDay());
            const hebrewDate = dayData.hebrew_date || '';
            headerRow.innerHTML += `<th class="day-col" title="${hebrewDate}">${dayName}<br><small>${hebrewDate}</small></th>`;
        });

        const firstDate = formatDate(weekDates[0]);
        const firstData = weeklyData[firstDate] || { students: [] };
        const classStudents = getClassStudents(firstData.students, selectedClass);

        if (classStudents.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="loading">××™×Ÿ ×ª×œ××™×“×™× ×‘×©×™×¢×•×¨ ×–×”</td></tr>';
            return;
        }

        tableBody.innerHTML = classStudents.map(student => {
            let rowHtml = `<tr><td class="student-col">${student.name}</td>`;

            weekDates.forEach(date => {
                const dateStr = formatDate(date);
                const dayData = weeklyData[dateStr] || { students: [] };
                const studentData = dayData.students.find(s => s.id === student.id);
                const status = studentData ? studentData.status : '×××ª×™×Ÿ';

                const statusClass = status === '× ×•×›×—' ? 'present' : status === '×—×¡×¨' ? 'absent' : 'unmarked';
                const symbol = status === '× ×•×›×—' ? 'âœ“' : status === '×—×¡×¨' ? 'âœ—' : '';

                rowHtml += `<td class="attendance-cell ${statusClass}" onclick="toggleAttendance(${student.id}, '${dateStr}', this)">${symbol}</td>`;
            });

            rowHtml += '</tr>';
            return rowHtml;
        }).join('');

        updateStats();
    }

    function toggleAttendance(studentId, dateStr, cellElement) {
        const dayData = weeklyData[dateStr];
        if (!dayData) return;

        const student = dayData.students.find(s => s.id === studentId);
        if (!student) return;

        let newStatus;
        if (student.status === '× ×•×›×—') {
            newStatus = 0;
        } else if (student.status === '×—×¡×¨') {
            newStatus = null;
        } else {
            newStatus = 1;
        }

        markAttendance(studentId, dateStr, newStatus, cellElement);
    }

    function markAttendance(studentId, dateStr, status, cellElement) {
        const statusText = status === 1 ? '× ×•×›×—' : status === 0 ? '×—×¡×¨' : '×××ª×™×Ÿ';

        const dayData = weeklyData[dateStr];
        const student = dayData.students.find(s => s.id === studentId);
        if (student) {
            student.status = statusText;
        }

        cellElement.className = 'attendance-cell';
        if (status === 1) {
            cellElement.textContent = 'âœ“';
            cellElement.classList.add('present');
        } else if (status === 0) {
            cellElement.textContent = 'âœ—';
            cellElement.classList.add('absent');
        } else {
            cellElement.textContent = '';
            cellElement.classList.add('unmarked');
        }

        if (status !== null) {
            fetch('/api/attendance/mark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    date: dateStr,
                    status: status,
                    prayer_type: selectedPrayer
                })
            }).catch(error => console.error('Error:', error));
        }

        updateStats();
    }

    function previousWeek() {
        weekStartDate.setDate(weekStartDate.getDate() - 7);
        loadWeeklyAttendance();
    }

    function nextWeek() {
        weekStartDate.setDate(weekStartDate.getDate() + 7);
        loadWeeklyAttendance();
    }

    function goToThisWeek() {
        weekStartDate = getStartOfWeek(new Date());
        loadWeeklyAttendance();
    }

    function markAllPresent() {
        const weekDates = getWeekDates(weekStartDate);
        const firstDate = formatDate(weekDates[0]);
        const firstData = weeklyData[firstDate] || { students: [] };
        const classStudents = getClassStudents(firstData.students, selectedClass);

        classStudents.forEach(student => {
            weekDates.forEach(date => {
                const dateStr = formatDate(date);
                const dayData = weeklyData[dateStr];
                if (dayData) {
                    const s = dayData.students.find(st => st.id === student.id);
                    if (s) {
                        s.status = '× ×•×›×—';
                        fetch('/api/attendance/mark', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                student_id: student.id,
                                date: dateStr,
                                status: 1,
                                prayer_type: selectedPrayer
                            })
                        });
                    }
                }
            });
        });

        displayWeeklyTable();
    }

    function markAllAbsent() {
        const weekDates = getWeekDates(weekStartDate);
        const firstDate = formatDate(weekDates[0]);
        const firstData = weeklyData[firstDate] || { students: [] };
        const classStudents = getClassStudents(firstData.students, selectedClass);

        classStudents.forEach(student => {
            weekDates.forEach(date => {
                const dateStr = formatDate(date);
                const dayData = weeklyData[dateStr];
                if (dayData) {
                    const s = dayData.students.find(st => st.id === student.id);
                    if (s) {
                        s.status = '×—×¡×¨';
                        fetch('/api/attendance/mark', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                student_id: student.id,
                                date: dateStr,
                                status: 0,
                                prayer_type: selectedPrayer
                            })
                        });
                    }
                }
            });
        });

        displayWeeklyTable();
    }

    function updateStats() {
        const weekDates = getWeekDates(weekStartDate);
        const firstDate = formatDate(weekDates[0]);
        const firstData = weeklyData[firstDate] || { students: [] };
        const classStudents = getClassStudents(firstData.students, selectedClass);

        let totalPresent = 0, totalAbsent = 0, totalUnmarked = 0;

        classStudents.forEach(student => {
            weekDates.forEach(date => {
                const dateStr = formatDate(date);
                const dayData = weeklyData[dateStr] || { students: [] };
                const studentData = dayData.students.find(s => s.id === student.id);
                const status = studentData ? studentData.status : '×××ª×™×Ÿ';

                if (status === '× ×•×›×—') totalPresent++;
                else if (status === '×—×¡×¨') totalAbsent++;
                else totalUnmarked++;
            });
        });

        document.getElementById('presentCount').textContent = totalPresent;
        document.getElementById('absentCount').textContent = totalAbsent;
        document.getElementById('unmarkedCount').textContent = totalUnmarked;

        const totalMarked = totalPresent + totalAbsent;
        const percentage = totalMarked > 0 ? Math.round((totalPresent / totalMarked) * 100) : 0;
        document.getElementById('percentCount').textContent = percentage + '%';

        const allGrades = ["×'", "×‘'", "×’'"];
        const gradeLabels = ['×', '×‘', '×’'];
        allGrades.forEach((grade, index) => {
            const gradeStudents = getClassStudents(firstData.students, grade);
            document.getElementById(`count${gradeLabels[index]}`).textContent = gradeStudents.length;
        });
    }

    window.addEventListener('load', loadWeeklyAttendance);
</script>

<!-- Rapid Filling Script -->
<script>
    let rapidFillingDate = null;
    let rapidStudents = [];
    let rapidCurrentIndex = 0;

    function startRapidFilling() {
        // ×¤×•×ª×— ××ª ××•×“×œ ×‘×—×™×¨×ª ×”×™×•× ×‘××§×•× ×œ×”×ª×—×™×œ ×™×©×¨
        showDaySelection();
    }

    function showDaySelection() {
        const weekDates = getWeekDates(weekStartDate);
        const dayGrid = document.getElementById('daySelectionGrid');
        dayGrid.innerHTML = '';

        weekDates.forEach(date => {
            const dateStr = formatDate(date);
            const dayData = weeklyData[dateStr] || {};
            const dayName = getHebrewDayName(date.getDay());
            const hebrewDate = dayData.hebrew_date || '';

            const dayButton = document.createElement('button');
            dayButton.className = 'day-selection-button';
            dayButton.onclick = () => selectDay(dateStr);

            // Add today class if it's today
            const today = formatDate(new Date());
            if (dateStr === today) {
                dayButton.classList.add('today');
            }

            dayButton.innerHTML = `
                <div class="day-name">${dayName}</div>
                <div class="day-date">${date.getDate()}/${date.getMonth() + 1}</div>
                <div class="hebrew-date">${hebrewDate}</div>
            `;

            dayGrid.appendChild(dayButton);
        });

        document.getElementById('daySelectionModal').style.display = 'block';
    }

    function selectDay(dateStr) {
        rapidFillingDate = dateStr;
        document.getElementById('daySelectionModal').style.display = 'none';
        startRapidFillingForDay(dateStr);
    }

    function closeDaySelection() {
        document.getElementById('daySelectionModal').style.display = 'none';
    }

    function startRapidFillingForDay(dateStr) {
        // Load students for the selected day
        rapidFillingDate = dateStr;

        fetch(`/api/rapid-filling/${dateStr}/${selectedPrayer}`)
            .then(response => response.json())
            .then(data => {
                const dayData = weeklyData[dateStr] || {};
                rapidStudents = data.map(student => {
                    const weekStudent = dayData.students ? dayData.students.find(s => s.id === student.id) : null;
                    return {
                        ...student,
                        status: weekStudent ? weekStudent.status : '×××ª×™×Ÿ'
                    };
                });

                if (rapidStudents.length === 0) {
                    alert('××™×Ÿ ×ª×œ××™×“×™× ×œ×”×¦×’×”');
                    return;
                }

                // Sort students by grade
                rapidStudents.sort((a, b) => {
                    const gradeA = a.grade || '×“';
                    const gradeB = b.grade || '×“';
                    return gradeA.localeCompare(gradeB);
                });

                rapidCurrentIndex = 0;
                displayCurrentStudent();
                updateRapidStats();
                document.getElementById('rapidFillingModal').style.display = 'block';

                // Add keyboard event listeners
                document.addEventListener('keydown', handleRapidKeyPress);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×œ××™×“×™×');
            });
    }

    function displayCurrentStudent() {
        if (rapidCurrentIndex >= rapidStudents.length) {
            // All students processed
            alert('×¡×™×•× ××™×œ×•×™ × ×•×›×—×•×ª!');
            closeRapidFilling();
            return;
        }

        const student = rapidStudents[rapidCurrentIndex];
        document.getElementById('rapidStudentName').textContent = student.name;
        document.getElementById('rapidStudentClass').textContent = `×©×™×¢×•×¨ ${student.grade}`;
        document.getElementById('rapidCurrentIndex').textContent = rapidCurrentIndex + 1;
        document.getElementById('rapidTotalCount').textContent = rapidStudents.length;

        // Update progress bar
        const progress = ((rapidCurrentIndex + 1) / rapidStudents.length) * 100;
        document.getElementById('rapidProgressBar').style.width = progress + '%';
    }

    function markRapidStudent(status) {
        const student = rapidStudents[rapidCurrentIndex];
        const statusText = status === 1 ? '× ×•×›×—' : '×—×¡×¨';

        // Update student status in array
        student.status = statusText;

        // Update in weeklyData
        const dayData = weeklyData[rapidFillingDate];
        if (dayData && dayData.students) {
            const weekStudent = dayData.students.find(s => s.id === student.id);
            if (weekStudent) {
                weekStudent.status = statusText;
            }
        }

        // Send to server
        fetch('/api/attendance/mark', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                student_id: student.id,
                date: rapidFillingDate,
                status: status,
                prayer_type: selectedPrayer
            })
        }).catch(error => console.error('Error saving:', error));

        // Move to next student
        rapidCurrentIndex++;
        displayCurrentStudent();
        updateRapidStats();

        // Update main table if visible
        if (document.getElementById('attendanceTable')) {
            displayWeeklyTable();
        }
    }

    function skipRapidStudent() {
        rapidCurrentIndex++;
        displayCurrentStudent();
    }

    function handleRapidKeyPress(event) {
        // Only handle if modal is open
        if (document.getElementById('rapidFillingModal').style.display !== 'block') {
            return;
        }

        // Prevent default for our keys
        if (event.key === 'v' || event.key === 'V' || event.key === '×”') { // V or Hebrew ×”
            event.preventDefault();
            markRapidStudent(1); // Present
        } else if (event.key === 'x' || event.key === 'X' || event.key === '×¡') { // X or Hebrew ×¡
            event.preventDefault();
            markRapidStudent(0); // Absent
        } else if (event.key === ' ') { // Space
            event.preventDefault();
            skipRapidStudent();
        } else if (event.key === 'Escape') {
            closeRapidFilling();
        }
    }

    function updateRapidStats() {
        let presentCount = 0, absentCount = 0, unmarkedCount = 0;

        rapidStudents.forEach(student => {
            if (student.status === '× ×•×›×—') presentCount++;
            else if (student.status === '×—×¡×¨') absentCount++;
            else unmarkedCount++;
        });

        document.getElementById('rapidPresentCount').textContent = presentCount;
        document.getElementById('rapidAbsentCount').textContent = absentCount;
        document.getElementById('rapidUnmarkedCount').textContent = unmarkedCount;
    }

    function closeRapidFilling() {
        document.getElementById('rapidFillingModal').style.display = 'none';
        // Remove keyboard event listener
        document.removeEventListener('keydown', handleRapidKeyPress);
    }

    function closeDaySelection() {
        document.getElementById('daySelectionModal').style.display = 'none';
    }
</script>
{% endblock %}
