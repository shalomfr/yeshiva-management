{% extends "base.html" %}

{% block title %}转 - 注专转  砖{% endblock %}

{% block content %}
<div class="reports-container">
    <!-- Header -->
    <div class="page-header">
        <h1> 转 转</h1>
        <p>爪驻 爪 砖 转 转 注 专驻 专拽</p>
    </div>

    <!-- Toolbar + Filters -->
    <div class="reports-toolbar">
        <div class="toolbar-left">
            <div class="segment" role="tablist" aria-label=" ">
                <button class="seg-btn active" data-range="week" onclick="applyPreset(this)">砖注 </button>
                <button class="seg-btn" data-range="month" onclick="applyPreset(this)">砖 </button>
                <button class="seg-btn" data-range="quarter" onclick="applyPreset(this)">专注</button>
                <button class="seg-btn" data-range="last" onclick="applyPreset(this)">专</button>
            </div>
        </div>
        <div class="toolbar-right">
            <button onclick="window.location.href='/student-report'" class="btn-link">  转 驻专</button>
            <button class="ghost" onclick="exportVisibleExcel()">爪 驻 砖爪</button>
            <button class="primary" onclick="exportToCSV()">爪 </button>
        </div>
    </div>

    <div class="filters-card">
        <div class="filters-row">
            <div class="field">
                <label>
                    <span id="dateTypeLabel">转专 (注专)</span>
                    <button onclick="toggleDateMode()" style="background: none; border: none; color: #4A90E2; cursor: pointer; font-size: 12px; margin-right: 10px;"> 祝 注</button>
                </label>
                <div class="input with-icon">
                    <span class="icon"></span>
                    <input type="text" id="startDate" placeholder='壮 砖 转砖驻"' value="" oninput="handleDateInput('start')">
                </div>
                <small id="startConverted" class="muted"></small>
            </div>
            <div class="field">
                <label>注 转专</label>
                <div class="input with-icon">
                    <span class="icon"></span>
                    <input type="text" id="endDate" placeholder='壮 砖 转砖驻"' value="" oninput="handleDateInput('end')">
                </div>
                <small id="endConverted" class="muted"></small>
            </div>
            <div class="field">
                <label>住 驻 砖注专</label>
                <div class="select">
                    <select id="reportGrade">
                        <option value=""> 砖注专</option>
                        <option value="'">'</option>
                        <option value="'">'</option>
                        <option value="'">'</option>
                    </select>
                </div>
                <small>&nbsp;</small>
            </div>
            <div class="field">
                <label>&nbsp;</label>
                <button class="btn btn-primary w-full" onclick="generateReport('custom')">爪 转爪转</button>
                <small>&nbsp;</small>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Attendance Distribution Pie Chart -->
        <div class="content-card chart-card">
            <h3 class="card-title">转驻转 转</h3>
            <div class="chart-wrapper">
                <canvas id="attendancePieChart"></canvas>
            </div>
        </div>

        <!-- Attendance by Grade Bar Chart -->
        <div class="content-card chart-card">
            <h3 class="card-title">转 驻 砖注专</h3>
            <div class="chart-wrapper">
                <canvas id="gradeBarChart"></canvas>
            </div>
        </div>

        <!-- Trend Line Chart -->
        <div class="content-card chart-card chart-wide">
            <h3 class="card-title">转 转 专 </h3>
            <div class="chart-wrapper-wide">
                <canvas id="trendLineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    <div class="content-card">
        <h2 class="card-title">转爪转 </h2>

        <div class="table-container">
            <table class="reports-table sticky" id="reportsTable">
                <thead>
                    <tr>
                        <th>砖</th>
                        <th>砖注专</th>
                        <th>转注转 转</th>
                        <th>转</th>
                        <th>注专转</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="reportsBody">
                    <tr>
                        <td colspan="6" class="empty-state">抓 "爪 转爪转" 注转 </td>
                    </tr>
                </tbody>
                <tfoot id="reportsFooter"></tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.chart-card {
    padding: 20px;
}

.chart-wide {
    grid-column: span 2;
}

.chart-wrapper {
    height: 250px;
    position: relative;
}

.chart-wrapper-wide {
    height: 300px;
    position: relative;
}

.btn-link {
    background: #4A90E2;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    .chart-wide {
        grid-column: span 1;
    }
}
</style>

<script>
    // Chart instances
    let pieChart = null;
    let barChart = null;
    let lineChart = null;
    
    // State management
    let isHebrewMode = true;
    let startDateGregorian = '';
    let endDateGregorian = '';
    let reportData = null;

    window.addEventListener('load', function() {
        initializeDates();
        initializeCharts();
    });

    function initializeCharts() {
        // Pie Chart - Attendance Distribution
        const pieCtx = document.getElementById('attendancePieChart').getContext('2d');
        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: ['', '住专', '专'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        rtl: true,
                        labels: { font: { size: 12 } }
                    }
                }
            }
        });

        // Bar Chart - By Grade
        const barCtx = document.getElementById('gradeBarChart').getContext('2d');
        barChart = new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: ["'", "'", "'"],
                datasets: [{
                    label: ' 转',
                    data: [0, 0, 0],
                    backgroundColor: '#3b82f6',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: v => v + '%' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Line Chart - Trend
        const lineCtx = document.getElementById('trendLineChart').getContext('2d');
        lineChart = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: ' 转',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: v => v + '%' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function updateCharts(data) {
        if (!data || !data.rows) return;

        // Calculate totals
        let totalPresent = 0;
        let totalAbsent = 0;
        let totalLate = 0;

        const gradeData = {};

        data.rows.forEach(row => {
            totalPresent += Number(row.present) || 0;
            totalAbsent += Number(row.absent) || 0;
            totalLate += Number(row.late) || 0;

            // Group by grade
            const grade = row.grade || ' 注';
            if (!gradeData[grade]) {
                gradeData[grade] = { present: 0, total: 0 };
            }
            gradeData[grade].present += Number(row.present) || 0;
            gradeData[grade].total += (Number(row.present) || 0) + (Number(row.absent) || 0);
        });

        // Update Pie Chart
        pieChart.data.datasets[0].data = [totalPresent, totalAbsent, totalLate];
        pieChart.update();

        // Update Bar Chart
        const grades = ["'", "'", "'"];
        const gradePercents = grades.map(g => {
            if (gradeData[g] && gradeData[g].total > 0) {
                return Math.round((gradeData[g].present / gradeData[g].total) * 100);
            }
            return 0;
        });
        barChart.data.datasets[0].data = gradePercents;
        barChart.update();

        // Update Line Chart with daily trend (if available)
        if (data.daily_trend) {
            lineChart.data.labels = data.daily_trend.map(d => d.date);
            lineChart.data.datasets[0].data = data.daily_trend.map(d => d.percent);
            lineChart.update();
        }
    }

    function initializeDates() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const gregorianDate = `${day}/${month}/${year}`;
        
        endDateGregorian = gregorianDate;
        
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 30);
        const startYear = startDate.getFullYear();
        const startMonth = String(startDate.getMonth() + 1).padStart(2, '0');
        const startDay = String(startDate.getDate()).padStart(2, '0');
        startDateGregorian = `${startDay}/${startMonth}/${startYear}`;
        
        convertToHebrew(startDateGregorian, 'start');
        convertToHebrew(gregorianDate, 'end');
    }

    function toggleDateMode() {
        isHebrewMode = !isHebrewMode;
        const toggleBtn = document.querySelector('button[onclick="toggleDateMode()"]');
        const label = document.getElementById('dateTypeLabel');
        
        if (isHebrewMode) {
            toggleBtn.textContent = ' 祝 注';
            label.textContent = '转专 (注专)';
            document.getElementById('startDate').placeholder = '壮 砖 转砖驻"';
            document.getElementById('endDate').placeholder = '壮 砖 转砖驻"';
            if (startDateGregorian) convertToHebrew(startDateGregorian, 'start');
            if (endDateGregorian) convertToHebrew(endDateGregorian, 'end');
        } else {
            toggleBtn.textContent = ' 祝 注专';
            label.textContent = '转专 (注)';
            document.getElementById('startDate').placeholder = 'DD/MM/YYYY';
            document.getElementById('endDate').placeholder = 'DD/MM/YYYY';
            document.getElementById('startDate').value = startDateGregorian;
            document.getElementById('endDate').value = endDateGregorian;
            document.getElementById('startConverted').textContent = '';
            document.getElementById('endConverted').textContent = '';
        }
    }

    function convertToHebrew(gregorianDate, field) {
        fetch(`/api/date/hebrew?date=${encodeURIComponent(gregorianDate)}`)
            .then(r => r.json())
            .then(d => {
                if (d.hebrew) {
                    document.getElementById(field + 'Date').value = d.hebrew;
                    document.getElementById(field + 'Converted').textContent = `(注: ${gregorianDate})`;
                }
            })
            .catch(err => console.error('Error converting date:', err));
    }

    function handleDateInput(field) {
        const value = document.getElementById(field + 'Date').value;
        if (!value) return;
        
        if (isHebrewMode) {
            fetch(`/api/date/gregorian?hebrew_date=${encodeURIComponent(value)}`)
                .then(r => r.json())
                .then(d => {
                    if (d.gregorian) {
                        if (field === 'start') {
                            startDateGregorian = d.gregorian;
                        } else {
                            endDateGregorian = d.gregorian;
                        }
                        document.getElementById(field + 'Converted').textContent = `(注: ${d.gregorian})`;
                    }
                })
                .catch(err => console.error('Error converting date:', err));
        } else {
            if (field === 'start') {
                startDateGregorian = value;
            } else {
                endDateGregorian = value;
            }
        }
    }

    function generateReport(reportType) {
        if (!startDateGregorian || !endDateGregorian) {
            alert('专  转专');
            return;
        }

        const grade = document.getElementById('reportGrade').value;

        fetch(`/api/reports/attendance?start_date=${encodeURIComponent(startDateGregorian)}&end_date=${encodeURIComponent(endDateGregorian)}&grade=${encodeURIComponent(grade)}`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert('砖: ' + data.error);
                    return;
                }
                
                reportData = data;
                
                const body = document.getElementById('reportsBody');
                if (!data.rows || data.rows.length === 0) {
                    body.innerHTML = `<tr><td colspan="6" class="empty-state"> 转  砖专</td></tr>`;
                    document.getElementById('reportsFooter').innerHTML = '';
                    return;
                }
                
                body.innerHTML = data.rows.map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.grade}</td>
                        <td>${r.id_number || ''}</td>
                        <td>${r.present}</td>
                        <td>${r.absent}</td>
                        <td><span class="percent-badge ${r.percent < 60 ? 'danger' : r.percent < 80 ? 'warning' : 'success'}">${r.percent}%</span></td>
                    </tr>
                `).join('');

                // Totals footer
                const totals = data.rows.reduce((acc, r) => {
                    acc.present += Number(r.present) || 0;
                    acc.absent += Number(r.absent) || 0;
                    acc.count += 1;
                    acc.percentSum += Number(r.percent) || 0;
                    return acc;
                }, {present:0, absent:0, count:0, percentSum:0});

                const avgPercent = totals.count ? Math.round(totals.percentSum / totals.count) : 0;
                document.getElementById('reportsFooter').innerHTML = `
                    <tr>
                        <th>住"/爪注</th>
                        <th></th>
                        <th></th>
                        <th>${totals.present}</th>
                        <th>${totals.absent}</th>
                        <th>${avgPercent}%</th>
                    </tr>
                `;
                
                // Update charts
                updateCharts(data);
            })
            .catch(err => {
                console.error(err);
                alert('砖 注转 ');
            });
    }

    function exportToCSV() {
        if (!startDateGregorian || !endDateGregorian) {
            alert('专  转专');
            return;
        }

        const grade = document.getElementById('reportGrade').value;

        fetch(`/api/export/csv?start_date=${encodeURIComponent(startDateGregorian)}&end_date=${encodeURIComponent(endDateGregorian)}&grade=${encodeURIComponent(grade)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('砖: ' + data.error);
                    return;
                }

                const blob = new Blob([data.csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);

                link.setAttribute("href", url);
                link.setAttribute("download", data.filename);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert(' 爪 爪!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('砖 爪');
            });
    }

    function applyPreset(button) {
        document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        const type = button.getAttribute('data-range');
        const today = new Date();

        function fmt(d) {
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yy = d.getFullYear();
            return `${dd}/${mm}/${yy}`;
        }

        let start;
        if (type === 'week') {
            const first = new Date(today);
            const day = first.getDay();
            first.setDate(first.getDate() - day);
            start = first;
        } else if (type === 'month') {
            start = new Date(today.getFullYear(), today.getMonth(), 1);
        } else if (type === 'quarter') {
            const qStartMonth = Math.floor(today.getMonth() / 3) * 3;
            start = new Date(today.getFullYear(), qStartMonth, 1);
        } else {
            start = new Date(today);
            start.setDate(start.getDate() - 30);
        }

        startDateGregorian = fmt(start);
        endDateGregorian = fmt(today);
        
        if (isHebrewMode) {
            convertToHebrew(startDateGregorian, 'start');
            convertToHebrew(endDateGregorian, 'end');
        } else {
            document.getElementById('startDate').value = startDateGregorian;
            document.getElementById('endDate').value = endDateGregorian;
        }
    }

    function exportVisibleExcel() {
        const table = document.getElementById('reportsTable');
        if (!table) return;

        const startDate = isHebrewMode ? document.getElementById('startDate').value : startDateGregorian;
        const endDate = isHebrewMode ? document.getElementById('endDate').value : endDateGregorian;
        const grade = document.getElementById('reportGrade').value || '';

        const html = `<!DOCTYPE html><html lang="he" dir="rtl"><head>
            <meta charset="UTF-8">
            <style>
                table { border-collapse: collapse; }
                th, td { border: 1px solid #CCCCCC; padding: 6px; text-align: center; }
                thead th { background: #e8f0fe; }
                tfoot th { background: #f1f3f4; font-weight: bold; }
            </style>
            </head><body>
            <h3> 转</h3>
            <div>: ${startDate} - ${endDate} | 砖注专: ${grade}</div>
            ${table.outerHTML}
            </body></html>`;

        const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url;
        a.download = `_转_${ts}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}
